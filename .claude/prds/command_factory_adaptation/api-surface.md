# API Surface: Command Factory System

> Generated by api-surface-analyzer for github/cli

## API Surface Summary

```
API Types: Library (Go package interfaces)
Total Exports: 40+ public types, interfaces, and functions
Authentication: Injected via Factory.HttpClient
Versioning: Not versioned (internal framework)
```

This document describes the public interfaces and contracts of the GitHub CLI's command factory system, which provides a dependency injection framework for CLI commands. The factory pattern enables consistent command construction, flag handling, and dependency management across all CLI commands.

---

## Core Factory Interface

### Package: `pkg/cmdutil`

The Factory struct is the primary public interface for command construction and dependency injection.

#### Factory Struct

**Purpose:** Provides dependency injection for all CLI commands

**Definition:**
```go
type Factory struct {
    // Version and executable information
    AppVersion     string
    ExecutableName string

    // Direct dependencies (concrete instances)
    Browser          browser.Browser
    ExtensionManager extensions.ExtensionManager
    GitClient        *git.Client
    IOStreams        *iostreams.IOStreams
    Prompter         prompter.Prompter

    // Lazy-loaded dependencies (function providers)
    BaseRepo        func() (ghrepo.Interface, error)
    Branch          func() (string, error)
    Config          func() (gh.Config, error)
    HttpClient      func() (*http.Client, error)
    PlainHttpClient func() (*http.Client, error)
    Remotes         func() (context.Remotes, error)
}
```

**Public Methods:**

##### Executable() string

**Description:** Returns the path to the currently invoked binary, respecting symlinks and PATH resolution

**Returns:** Absolute path to the gh executable

**Example:**
```go
func (f *Factory) Executable() string {
    ghPath := os.Getenv("GH_PATH")
    if ghPath != "" {
        return ghPath
    }
    if !strings.ContainsRune(f.ExecutableName, os.PathSeparator) {
        f.ExecutableName = executable(f.ExecutableName)
    }
    return f.ExecutableName
}
```

**Usage Pattern:**
```go
factory := &cmdutil.Factory{
    AppVersion:     "2.0.0",
    ExecutableName: "gh",
    IOStreams:      iostreams.System(),
    Browser:        browser.New("", os.Stdout, os.Stderr),
    Prompter:       prompter.New("", iostreams.System()),
    GitClient:      &git.Client{},
    HttpClient:     func() (*http.Client, error) { return api.NewHTTPClient(...) },
    BaseRepo:       func() (ghrepo.Interface, error) { return resolveRepo() },
    Config:         func() (gh.Config, error) { return config.Read() },
    // ... other dependencies
}
```

---

## Command Creation Contract

### NewCmd* Function Signature Pattern

All commands follow a consistent creation pattern:

**Signature:**
```go
func NewCmd<Name>(f *cmdutil.Factory, runF func(*<Name>Options) error) *cobra.Command
```

**Parameters:**
| Name | Type | Required | Description |
|------|------|----------|-------------|
| f | *cmdutil.Factory | yes | Factory providing dependencies |
| runF | func(*Options) error | no | Optional test injection for run function |

**Returns:** Configured `*cobra.Command` ready to add to command tree

**Example:**
```go
// From pkg/cmd/pr/list/list.go
func NewCmdList(f *cmdutil.Factory, runF func(*ListOptions) error) *cobra.Command {
    opts := &ListOptions{
        IO:         f.IOStreams,
        HttpClient: f.HttpClient,
        Browser:    f.Browser,
        Now:        time.Now,
    }

    cmd := &cobra.Command{
        Use:   "list",
        Short: "List pull requests in a repository",
        RunE: func(cmd *cobra.Command, args []string) error {
            opts.BaseRepo = f.BaseRepo

            if runF != nil {
                return runF(opts)
            }
            return listRun(opts)
        },
    }

    // Flag registration
    cmd.Flags().BoolVarP(&opts.WebMode, "web", "w", false, "List pull requests in the web browser")
    cmdutil.AddJSONFlags(cmd, &opts.Exporter, api.PullRequestFields)

    return cmd
}
```

---

## Options Struct Pattern

### Per-Command Dependency Requirements

Each command defines an Options struct that specifies its dependencies.

**Standard Pattern:**
```go
type <Command>Options struct {
    // Factory-provided dependencies
    HttpClient func() (*http.Client, error)
    IO         *iostreams.IOStreams
    BaseRepo   func() (ghrepo.Interface, error)
    Browser    browser.Browser
    Prompter   prompter.Prompter
    GitClient  *git.Client

    // Optional dependencies
    Detector   fd.Detector

    // Command-specific flags
    WebMode      bool
    LimitResults int
    Exporter     cmdutil.Exporter

    // State and other fields
    State      string
    Labels     []string
    // ... command-specific fields
}
```

**Example: PR List Options**
```go
type ListOptions struct {
    HttpClient func() (*http.Client, error)
    IO         *iostreams.IOStreams
    BaseRepo   func() (ghrepo.Interface, error)
    Browser    browser.Browser
    Detector   fd.Detector

    WebMode      bool
    LimitResults int
    Exporter     cmdutil.Exporter

    State      string
    BaseBranch string
    HeadBranch string
    Labels     []string
    Author     string
    Assignee   string
    Search     string
    Draft      *bool

    Now func() time.Time
}
```

---

## Flag Helper Functions

### Package: `pkg/cmdutil`

#### NilStringFlag

**Description:** Defines a new flag with a string pointer receiver for distinguishing between blank values and unset flags

**Signature:**
```go
func NilStringFlag(cmd *cobra.Command, p **string, name string, shorthand string, usage string) *pflag.Flag
```

**Parameters:**
| Name | Type | Required | Description |
|------|------|----------|-------------|
| cmd | *cobra.Command | yes | Command to add flag to |
| p | **string | yes | Pointer to string pointer for value |
| name | string | yes | Long flag name |
| shorthand | string | yes | Short flag name (or "") |
| usage | string | yes | Help text |

**Returns:** The created flag

**Example:**
```go
var title *string
cmdutil.NilStringFlag(cmd, &title, "title", "t", "Pull request title")

// Later: distinguish between unset and empty
if title == nil {
    // Flag was not provided
} else if *title == "" {
    // Flag was provided but empty
} else {
    // Flag has a value: *title
}
```

---

#### NilBoolFlag

**Description:** Defines a new flag with a bool pointer receiver for distinguishing between explicit false and unset flags

**Signature:**
```go
func NilBoolFlag(cmd *cobra.Command, p **bool, name string, shorthand string, usage string) *pflag.Flag
```

**Parameters:**
| Name | Type | Required | Description |
|------|------|----------|-------------|
| cmd | *cobra.Command | yes | Command to add flag to |
| p | **bool | yes | Pointer to bool pointer for value |
| name | string | yes | Long flag name |
| shorthand | string | yes | Short flag name (or "") |
| usage | string | yes | Help text |

**Returns:** The created flag with NoOptDefVal set to "true"

**Example:**
```go
var draft *bool
cmdutil.NilBoolFlag(cmd, &draft, "draft", "d", "Filter by draft state")

// Later: check state
if draft == nil {
    // No filtering on draft state
} else if *draft {
    // Filter for drafts only
} else {
    // Filter for non-drafts only
}
```

---

#### StringEnumFlag

**Description:** Defines a new string flag that only allows values from a predefined set

**Signature:**
```go
func StringEnumFlag(cmd *cobra.Command, p *string, name, shorthand, defaultValue string, options []string, usage string) *pflag.Flag
```

**Parameters:**
| Name | Type | Required | Description |
|------|------|----------|-------------|
| cmd | *cobra.Command | yes | Command to add flag to |
| p | *string | yes | Pointer to string for value |
| name | string | yes | Long flag name |
| shorthand | string | yes | Short flag name (or "") |
| defaultValue | string | yes | Initial value |
| options | []string | yes | Allowed values |
| usage | string | yes | Help text (values will be appended) |

**Returns:** The created flag with completion function registered

**Validation:** Returns error if value not in options (case-insensitive)

**Example:**
```go
var state string
cmdutil.StringEnumFlag(cmd, &state, "state", "s", "open",
    []string{"open", "closed", "merged", "all"},
    "Filter by state")

// Flag usage shows: "Filter by state: {open|closed|merged|all}"
```

---

#### StringSliceEnumFlag

**Description:** Defines a new string slice flag that only allows values from a predefined set

**Signature:**
```go
func StringSliceEnumFlag(cmd *cobra.Command, p *[]string, name, shorthand string, defaultValues, options []string, usage string) *pflag.Flag
```

**Parameters:**
| Name | Type | Required | Description |
|------|------|----------|-------------|
| cmd | *cobra.Command | yes | Command to add flag to |
| p | *[]string | yes | Pointer to string slice for values |
| name | string | yes | Long flag name |
| shorthand | string | yes | Short flag name (or "") |
| defaultValues | []string | yes | Initial values |
| options | []string | yes | Allowed values |
| usage | string | yes | Help text (values will be appended) |

**Returns:** The created flag with completion function registered

**Example:**
```go
var labels []string
cmdutil.StringSliceEnumFlag(cmd, &labels, "label", "l",
    nil,
    []string{"bug", "enhancement", "documentation"},
    "Filter by labels")
```

---

#### RegisterBranchCompletionFlags

**Description:** Suggests and autocompletes known remote git branches for specified flags

**Signature:**
```go
func RegisterBranchCompletionFlags(gitc gitClient, cmd *cobra.Command, flags ...string) error
```

**Parameters:**
| Name | Type | Required | Description |
|------|------|----------|-------------|
| gitc | gitClient | yes | Git client for fetching branches |
| cmd | *cobra.Command | yes | Command to register completions on |
| flags | ...string | yes | Flag names to enable completion for |

**gitClient Interface:**
```go
type gitClient interface {
    TrackingBranchNames(context.Context, string) []string
}
```

**Returns:** Error if flag registration fails

**Example:**
```go
_ = cmdutil.RegisterBranchCompletionFlags(f.GitClient, cmd, "base", "head")
```

---

### Package: `pkg/cmdutil` - JSON Export Flags

#### AddJSONFlags

**Description:** Adds --json, --jq, and --template flags with field validation and shell completion

**Signature:**
```go
func AddJSONFlags(cmd *cobra.Command, exportTarget *Exporter, fields []string)
```

**Parameters:**
| Name | Type | Required | Description |
|------|------|----------|-------------|
| cmd | *cobra.Command | yes | Command to add flags to |
| exportTarget | *Exporter | yes | Pointer to store exporter instance |
| fields | []string | yes | Allowed field names for JSON output |

**Behavior:**
- Adds three flags: --json (with -j shorthand), --jq (with -q), --template (with -t)
- Registers field completion for --json flag
- Validates fields in PreRunE hook
- Sets exportTarget to nil if no JSON output requested
- Stores field list in command annotations as "help:json-fields"

**Example:**
```go
var exporter cmdutil.Exporter
cmdutil.AddJSONFlags(cmd, &exporter, api.PullRequestFields)

// In RunE:
if exporter != nil {
    // Output as JSON
    return exporter.Write(opts.IO, pullRequests)
}
// Otherwise normal output
```

---

#### AddJSONFlagsWithoutShorthand

**Description:** Same as AddJSONFlags but without short flag aliases

**Signature:**
```go
func AddJSONFlagsWithoutShorthand(cmd *cobra.Command, exportTarget *Exporter, fields []string)
```

**Use Case:** Commands where short flags conflict with other flags

---

#### AddFormatFlags

**Description:** Adds --format flag with enum validation (currently only "json")

**Signature:**
```go
func AddFormatFlags(cmd *cobra.Command, exportTarget *Exporter)
```

**Parameters:**
| Name | Type | Required | Description |
|------|------|----------|-------------|
| cmd | *cobra.Command | yes | Command to add flag to |
| exportTarget | *Exporter | yes | Pointer to store exporter instance |

**Flags Added:**
- --format (enum: "json")
- --jq (with -q shorthand)
- --template (with -t shorthand)

---

## Shared Types

### Package: `pkg/cmdutil`

#### Exporter Interface

**Description:** Interface for outputting data in JSON format with optional filtering

**Definition:**
```go
type Exporter interface {
    Fields() []string
    Write(io *iostreams.IOStreams, data interface{}) error
}
```

**Methods:**

##### Fields() []string

**Description:** Returns the list of field names to export

**Returns:** String slice of field names

##### Write(io *iostreams.IOStreams, data interface{}) error

**Description:** Serializes data into JSON output, optionally applying jq filter or Go template

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| io | *iostreams.IOStreams | I/O streams for output |
| data | interface{} | Data to export |

**Returns:** Error if serialization, filtering, or writing fails

**Behavior:**
- Calls ExportData() method on exportable types
- Applies jq filter if specified
- Applies Go template if specified
- Outputs colorized JSON if terminal supports it

**Example:**
```go
type PullRequest struct {
    Number int
    Title  string
    State  string
}

func (pr *PullRequest) ExportData(fields []string) map[string]interface{} {
    data := make(map[string]interface{})
    for _, f := range fields {
        switch strings.ToLower(f) {
        case "number":
            data["number"] = pr.Number
        case "title":
            data["title"] = pr.Title
        case "state":
            data["state"] = pr.State
        }
    }
    return data
}

// Usage:
exporter := cmdutil.NewJSONExporter()
exporter.SetFields([]string{"number", "title"})
exporter.Write(io, pullRequests)
```

---

#### NewJSONExporter() *jsonExporter

**Description:** Creates a new JSON exporter without field restrictions

**Returns:** Exporter instance

---

#### StructExportData(s interface{}, fields []string) map[string]interface{}

**Description:** Helper function for implementing ExportData on structs via reflection

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| s | interface{} | Struct or pointer to struct |
| fields | []string | Field names to export |

**Returns:** Map of field name to value

**Limitations:**
- Basic reflection-based implementation
- May not work for complex types
- Custom ExportData implementation recommended for complex cases

**Example:**
```go
func (pr *PullRequest) ExportData(fields []string) map[string]interface{} {
    return cmdutil.StructExportData(pr, fields)
}
```

---

### Package: `pkg/cmd/pr/shared`

#### FilterOptions Struct

**Description:** Common filtering options for listing pull requests and issues

**Definition:**
```go
type FilterOptions struct {
    Assignee   string
    Author     string
    BaseBranch string
    Draft      *bool
    Entity     string
    Fields     []string
    HeadBranch string
    Labels     []string
    Mention    string
    Milestone  string
    Repo       string
    Search     string
    State      string
}
```

**Methods:**

##### IsDefault() bool

**Description:** Returns true if only default filters are applied (state="open")

**Returns:** Boolean indicating if filters are in default state

---

#### Editable Types

**Description:** Types for interactive editing of pull request/issue metadata

##### Editable Struct

**Definition:**
```go
type Editable struct {
    Title     EditableString
    Body      EditableString
    Base      EditableString
    Reviewers EditableSlice
    Assignees EditableAssignees
    Labels    EditableSlice
    Projects  EditableProjects
    Milestone EditableString
    Metadata  api.RepoMetadataResult
}
```

**Methods:**

###### Dirty() bool

**Description:** Returns true if any field has been edited

**Returns:** Boolean indicating if edits exist

###### TitleValue() *string

**Description:** Returns title if edited, nil otherwise

**Returns:** Pointer to title string or nil

###### BodyValue() *string

**Description:** Returns body if edited, nil otherwise

**Returns:** Pointer to body string or nil

###### AssigneeIds(client *api.Client, repo ghrepo.Interface) (*[]string, error)

**Description:** Converts assignee names to GitHub IDs

**Returns:** Pointer to slice of assignee IDs or nil if not edited

###### ProjectIds() (*[]string, error)

**Description:** Returns IDs of Projects v1 to link

**Returns:** Pointer to slice of project IDs or nil if not edited

###### ProjectV2Ids() (*[]string, *[]string, error)

**Description:** Returns IDs of Projects v2 to add and remove

**Returns:** Pointer to add slice, pointer to remove slice, and error

###### MilestoneId() (*string, error)

**Description:** Converts milestone title to GitHub ID

**Returns:** Pointer to milestone ID or nil if not edited

###### Clone() Editable

**Description:** Creates a mostly-shallow copy suitable for parallel goroutines

**Returns:** Copied Editable struct

---

##### EditableString Struct

**Definition:**
```go
type EditableString struct {
    Value   string
    Default string
    Options []string
    Edited  bool
}
```

---

##### EditableSlice Struct

**Definition:**
```go
type EditableSlice struct {
    Value   []string
    Add     []string
    Remove  []string
    Default []string
    Options []string
    Edited  bool
    Allowed bool
}
```

---

##### EditableAssignees Struct

**Description:** Special case of EditableSlice with actor support

**Definition:**
```go
type EditableAssignees struct {
    EditableSlice
    ActorAssignees bool
    DefaultLogins  []string
}
```

---

##### EditableProjects Struct

**Description:** EditableSlice with project item ID mapping

**Definition:**
```go
type EditableProjects struct {
    EditableSlice
    ProjectItems map[string]string
}
```

---

#### IssueMetadataState Struct

**Description:** State for issue/PR metadata during creation or editing

**Definition:**
```go
type IssueMetadataState struct {
    Type metadataStateType

    Draft          bool
    ActorAssignees bool

    Body  string
    Title string

    Template string

    Metadata      []string
    Reviewers     []string
    Assignees     []string
    Labels        []string
    ProjectTitles []string
    Milestones    []string

    MetadataResult *api.RepoMetadataResult

    dirty bool
}
```

**Methods:**

##### MarkDirty()

**Description:** Marks the state as having been modified by user I/O

##### IsDirty() bool

**Description:** Returns true if state has been modified

**Returns:** Boolean indicating if dirty

##### HasMetadata() bool

**Description:** Returns true if any metadata fields are set

**Returns:** Boolean indicating metadata presence

---

## Interface Contracts

### Package: `internal/browser`

#### Browser Interface

**Description:** Interface for opening URLs in a web browser

**Definition:**
```go
type Browser interface {
    Browse(string) error
}
```

**Methods:**

##### Browse(url string) error

**Description:** Opens the specified URL in the system's default browser

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| url | string | URL to open |

**Returns:** Error if browser launch fails

**Example:**
```go
browser := browser.New("", os.Stdout, os.Stderr)
err := browser.Browse("https://github.com/cli/cli")
```

**Factory Method:**
```go
func New(launcher string, stdout, stderr io.Writer) Browser
```

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| launcher | string | Custom browser command (empty for default) |
| stdout | io.Writer | Standard output |
| stderr | io.Writer | Standard error |

---

### Package: `internal/prompter`

#### Prompter Interface

**Description:** Interface for interactive user prompts in the terminal

**Definition:**
```go
type Prompter interface {
    // Generic prompts from go-gh
    Select(prompt string, defaultValue string, options []string) (int, error)
    MultiSelect(prompt string, defaults []string, options []string) ([]int, error)
    Input(prompt string, defaultValue string) (string, error)
    Password(prompt string) (string, error)
    Confirm(prompt string, defaultValue bool) (bool, error)

    // gh-specific prompts
    AuthToken() (string, error)
    ConfirmDeletion(requiredValue string) error
    InputHostname() (string, error)
    MarkdownEditor(prompt string, defaultValue string, blankAllowed bool) (string, error)
}
```

**Methods:**

##### Select(prompt string, defaultValue string, options []string) (int, error)

**Description:** Prompts the user to select one option from a list

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| prompt | string | Prompt text |
| defaultValue | string | Default selection |
| options | []string | Available options |

**Returns:** Index of selected option and error

---

##### MultiSelect(prompt string, defaults []string, options []string) ([]int, error)

**Description:** Prompts the user to select one or more options from a list

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| prompt | string | Prompt text |
| defaults | []string | Default selections |
| options | []string | Available options |

**Returns:** Indices of selected options and error

---

##### Input(prompt string, defaultValue string) (string, error)

**Description:** Prompts the user to enter a string value

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| prompt | string | Prompt text |
| defaultValue | string | Default value |

**Returns:** User input string and error

---

##### Password(prompt string) (string, error)

**Description:** Prompts the user to enter a password (hidden input)

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| prompt | string | Prompt text |

**Returns:** Password string and error

---

##### Confirm(prompt string, defaultValue bool) (bool, error)

**Description:** Prompts the user to confirm an action (yes/no)

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| prompt | string | Prompt text |
| defaultValue | bool | Default confirmation value |

**Returns:** Boolean confirmation and error

---

##### AuthToken() (string, error)

**Description:** Prompts the user to enter an authentication token (hidden input)

**Returns:** Token string and error

---

##### ConfirmDeletion(requiredValue string) error

**Description:** Prompts the user to confirm deletion by typing the exact required value

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| requiredValue | string | Value user must type to confirm |

**Returns:** Error if confirmation fails or user cancels

---

##### InputHostname() (string, error)

**Description:** Prompts the user to enter a GitHub hostname with validation

**Returns:** Validated hostname and error

---

##### MarkdownEditor(prompt string, defaultValue string, blankAllowed bool) (string, error)

**Description:** Prompts the user to edit markdown content in an external editor

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| prompt | string | Prompt text |
| defaultValue | string | Initial content |
| blankAllowed | bool | Whether blank content is allowed |

**Returns:** Edited markdown content and error

---

**Factory Method:**
```go
func New(editorCmd string, io *iostreams.IOStreams) Prompter
```

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| editorCmd | string | Editor command for markdown editing |
| io | *iostreams.IOStreams | I/O streams |

**Behavior:** Returns accessible prompter or survey prompter based on environment

---

#### EditPrompter Interface

**Description:** Subset of Prompter interface used for editing operations

**Definition:**
```go
type EditPrompter interface {
    Select(string, string, []string) (int, error)
    Input(string, string) (string, error)
    MarkdownEditor(string, string, bool) (string, error)
    MultiSelect(string, []string, []string) ([]int, error)
    Confirm(string, bool) (bool, error)
}
```

---

### Package: `pkg/extensions`

#### ExtensionManager Interface

**Description:** Interface for managing GitHub CLI extensions

**Definition:**
```go
type ExtensionManager interface {
    List() []Extension
    Install(ghrepo.Interface, string) error
    InstallLocal(dir string) error
    Upgrade(name string, force bool) error
    Remove(name string) error
    Dispatch(args []string, stdin io.Reader, stdout, stderr io.Writer) (bool, error)
    Create(name string, tmplType ExtTemplateType) error
    EnableDryRunMode()
    UpdateDir(name string) string
}
```

**Methods:**

##### List() []Extension

**Description:** Returns list of installed extensions

**Returns:** Slice of Extension interfaces

---

##### Install(repo ghrepo.Interface, tag string) error

**Description:** Installs an extension from a GitHub repository

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| repo | ghrepo.Interface | Repository to install from |
| tag | string | Version tag (or "" for latest) |

**Returns:** Error if installation fails

---

##### InstallLocal(dir string) error

**Description:** Installs an extension from a local directory

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| dir | string | Local directory path |

**Returns:** Error if installation fails

---

##### Upgrade(name string, force bool) error

**Description:** Upgrades an installed extension

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| name | string | Extension name |
| force | bool | Force upgrade even if up to date |

**Returns:** Error if upgrade fails

---

##### Remove(name string) error

**Description:** Removes an installed extension

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| name | string | Extension name |

**Returns:** Error if removal fails

---

##### Dispatch(args []string, stdin io.Reader, stdout, stderr io.Writer) (bool, error)

**Description:** Dispatches a command to an extension if it matches

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| args | []string | Command arguments |
| stdin | io.Reader | Standard input |
| stdout | io.Writer | Standard output |
| stderr | io.Writer | Standard error |

**Returns:** Boolean indicating if extension was found and executed, and error

---

##### Create(name string, tmplType ExtTemplateType) error

**Description:** Creates a new extension from a template

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| name | string | Extension name |
| tmplType | ExtTemplateType | Template type (Git, GoBin, OtherBin) |

**Returns:** Error if creation fails

---

##### EnableDryRunMode()

**Description:** Enables dry-run mode for testing without side effects

---

##### UpdateDir(name string) string

**Description:** Returns the update directory for an extension

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| name | string | Extension name |

**Returns:** Update directory path

---

#### Extension Interface

**Definition:**
```go
type Extension interface {
    Name() string
    Path() string
    URL() string
    CurrentVersion() string
    LatestVersion() string
    IsPinned() bool
    UpdateAvailable() bool
    IsBinary() bool
    IsLocal() bool
    Owner() string
}
```

---

### Package: `internal/featuredetection`

#### Detector Interface

**Description:** Interface for detecting GitHub server feature support

**Definition:**
```go
type Detector interface {
    IssueFeatures() (IssueFeatures, error)
    PullRequestFeatures() (PullRequestFeatures, error)
    RepositoryFeatures() (RepositoryFeatures, error)
    ProjectsV1() gh.ProjectsV1Support
    SearchFeatures() (SearchFeatures, error)
    ReleaseFeatures() (ReleaseFeatures, error)
}
```

**Purpose:** Detects which features are available on the GitHub server (useful for GHES compatibility)

---

### Package: `internal/ghrepo`

#### Interface

**Description:** Minimal interface representing a GitHub repository

**Definition:**
```go
type Interface interface {
    RepoName() string
    RepoOwner() string
    RepoHost() string
}
```

**Methods:**

##### RepoName() string

**Description:** Returns the repository name

**Returns:** Repository name

##### RepoOwner() string

**Description:** Returns the repository owner (user or organization)

**Returns:** Owner name

##### RepoHost() string

**Description:** Returns the GitHub host (e.g., "github.com" or GHES hostname)

**Returns:** Host name

**Factory Functions:**
```go
func New(owner, repo string) Interface
func NewWithHost(owner, repo, hostname string) Interface
func FromFullName(nwo string) (Interface, error)
func FromFullNameWithHost(nwo, hostname string) (Interface, error)
func FromURL(url *url.URL) (Interface, error)
```

---

### Package: `git`

#### Client Struct

**Description:** Client for executing git commands

**Definition:**
```go
type Client struct {
    GhPath  string
    RepoDir string
    GitPath string
    Stderr  io.Writer
    Stdin   io.Reader
    Stdout  io.Writer
}
```

**Key Methods:**

##### Command(ctx context.Context, args ...string) (*Command, error)

**Description:** Creates a git command

##### AuthenticatedCommand(ctx context.Context, credentialPattern CredentialPattern, args ...string) (*Command, error)

**Description:** Creates a git command with gh as credential helper

##### TrackingBranchNames(ctx context.Context, prefix string) []string

**Description:** Returns list of tracking branch names matching prefix

**Note:** Used by RegisterBranchCompletionFlags

---

### Package: `pkg/iostreams`

#### IOStreams Struct

**Description:** Encapsulates I/O streams with terminal detection and formatting

**Public Fields:**
```go
type IOStreams struct {
    In     fileReader
    Out    fileWriter
    ErrOut fileWriter

    TempFileOverride *os.File
}
```

**Key Methods:**

##### ColorEnabled() bool

**Description:** Returns true if color output is enabled

##### IsStdinTTY() bool

**Description:** Returns true if stdin is a terminal

##### IsStdoutTTY() bool

**Description:** Returns true if stdout is a terminal

##### IsStderrTTY() bool

**Description:** Returns true if stderr is a terminal

##### ColorScheme() *ColorScheme

**Description:** Returns the color scheme for output formatting

##### TerminalTheme() string

**Description:** Returns "light", "dark", or "none" for the terminal theme

##### SetColorEnabled(enabled bool)

**Description:** Overrides color detection

##### SetPager(cmd string)

**Description:** Sets the pager command

##### StartPager() error

**Description:** Starts the output pager

##### StopPager()

**Description:** Stops the output pager

---

### Package: `context`

#### Remotes Type

**Description:** Slice of remote repositories

**Definition:**
```go
type Remotes []*Remote
```

**Remote Struct:**
```go
type Remote struct {
    Name     string
    FetchURL *url.URL
    PushURL  *url.URL
}
```

---

## Error Types

### Package: `pkg/cmdutil`

#### FlagError

**Description:** Error type indicating invalid command-line flags

**Definition:**
```go
type FlagError struct {
    err error
}
```

**Behavior:** Causes the application to display usage message

**Factory Functions:**

##### FlagErrorf(format string, args ...interface{}) error

**Description:** Creates FlagError from formatted string

**Example:**
```go
return cmdutil.FlagErrorf("invalid value for --limit: %v", limit)
```

##### FlagErrorWrap(err error) error

**Description:** Wraps an existing error as FlagError

**Example:**
```go
return cmdutil.FlagErrorWrap(err)
```

---

#### Sentinel Errors

##### SilentError

**Description:** Error that triggers exit code 1 without any error messaging

**Definition:**
```go
var SilentError = errors.New("SilentError")
```

**Usage:**
```go
return cmdutil.SilentError
```

---

##### CancelError

**Description:** Error signaling user-initiated cancellation

**Definition:**
```go
var CancelError = errors.New("CancelError")
```

**Helper Function:**
```go
func IsUserCancellation(err error) bool
```

**Description:** Returns true if error is CancelError or terminal.InterruptErr

---

##### PendingError

**Description:** Error signaling nothing failed but something is pending

**Definition:**
```go
var PendingError = errors.New("PendingError")
```

**Use Case:** Used for async operations that are still in progress

---

#### NoResultsError

**Description:** Error type for empty query results

**Definition:**
```go
type NoResultsError struct {
    message string
}
```

**Factory Function:**
```go
func NewNoResultsError(message string) NoResultsError
```

**Example:**
```go
return cmdutil.NewNoResultsError(fmt.Sprintf("no open issues in %s", repoName))
```

---

#### JSONFlagError

**Description:** Error wrapper for JSON flag-related errors

**Definition:**
```go
type JSONFlagError struct {
    error
}
```

**Use Case:** Distinguishes JSON flag errors from other errors for special handling

---

### Package: `pkg/cmdutil`

#### MutuallyExclusive(message string, conditions ...bool) error

**Description:** Helper for validating mutually exclusive flags

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| message | string | Error message |
| conditions | ...bool | Boolean conditions to check |

**Returns:** FlagError if more than one condition is true, nil otherwise

**Example:**
```go
err := cmdutil.MutuallyExclusive(
    "specify only `--author` or `--app`",
    cmd.Flags().Changed("author"),
    cmd.Flags().Changed("app"),
)
if err != nil {
    return err
}
```

---

## Authentication and Authorization

### Package: `pkg/cmdutil`

#### DisableAuthCheck(cmd *cobra.Command)

**Description:** Marks a command as not requiring authentication

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| cmd | *cobra.Command | Command to mark |

**Usage:**
```go
cmd := &cobra.Command{...}
cmdutil.DisableAuthCheck(cmd)
```

---

#### DisableAuthCheckFlag(flag *pflag.Flag)

**Description:** Marks a flag as disabling authentication check when set

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| flag | *pflag.Flag | Flag to mark |

**Usage:**
```go
webFlag := cmd.Flags().Lookup("web")
cmdutil.DisableAuthCheckFlag(webFlag)
```

---

#### CheckAuth(cfg gh.Config) bool

**Description:** Checks if user is authenticated

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| cfg | gh.Config | Configuration to check |

**Returns:** True if user has authentication token or configured hosts

---

#### IsAuthCheckEnabled(cmd *cobra.Command) bool

**Description:** Determines if authentication check should be performed for a command

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| cmd | *cobra.Command | Command to check |

**Returns:** True if auth check is enabled

**Behavior:**
- Returns false for help and completion commands
- Returns false if command or parent marked with DisableAuthCheck
- Returns false if a flag marked with DisableAuthCheckFlag is set

---

## Utility Functions

### Package: `pkg/cmd/pr/shared`

#### FetchOptions(client *api.Client, repo ghrepo.Interface, editable *Editable, projectV1Support gh.ProjectsV1Support) error

**Description:** Fetches available options for metadata fields from GitHub API

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| client | *api.Client | API client |
| repo | ghrepo.Interface | Repository |
| editable | *Editable | Editable to populate |
| projectV1Support | gh.ProjectsV1Support | Projects v1 support level |

**Returns:** Error if API call fails

**Behavior:** Populates Options fields in Editable with available assignees, labels, projects, milestones, etc.

---

#### EditFieldsSurvey(p EditPrompter, editable *Editable, editorCommand string) error

**Description:** Prompts user to interactively edit fields marked as Edited

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| p | EditPrompter | Prompter for user interaction |
| editable | *Editable | Fields to edit |
| editorCommand | string | Editor command for markdown |

**Returns:** Error if user cancels or prompts fail

---

#### FieldsToEditSurvey(p EditPrompter, editable *Editable) error

**Description:** Prompts user to select which fields they want to edit

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| p | EditPrompter | Prompter for user interaction |
| editable | *Editable | Editable to mark fields on |

**Returns:** Error if prompt fails

**Behavior:** Sets Edited=true on selected fields

---

#### AddMetadataToIssueParams(client *api.Client, baseRepo ghrepo.Interface, params map[string]interface{}, tb *IssueMetadataState, projectV1Support gh.ProjectsV1Support) error

**Description:** Converts metadata state to GraphQL mutation parameters

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| client | *api.Client | API client |
| baseRepo | ghrepo.Interface | Repository |
| params | map[string]interface{} | Parameters map to populate |
| tb | *IssueMetadataState | Metadata state |
| projectV1Support | gh.ProjectsV1Support | Projects v1 support |

**Returns:** Error if ID resolution fails

**Behavior:** Populates params with assigneeIds, labelIds, projectIds, projectV2Ids, milestoneId, userReviewerIds, teamReviewerIds

---

#### WithPrAndIssueQueryParams(client *api.Client, baseRepo ghrepo.Interface, baseURL string, state IssueMetadataState, projectsV1Support gh.ProjectsV1Support) (string, error)

**Description:** Adds query parameters to URL for web browser issue/PR creation

**Parameters:**
| Name | Type | Description |
|------|------|-------------|
| client | *api.Client | API client |
| baseRepo | ghrepo.Interface | Repository |
| baseURL | string | Base URL to add params to |
| state | IssueMetadataState | Metadata state |
| projectsV1Support | gh.ProjectsV1Support | Projects v1 support |

**Returns:** URL with query parameters and error

---

#### MeReplacer

**Description:** Utility for resolving `@me` to the current user's login

**Definition:**
```go
type MeReplacer struct {
    apiClient *api.Client
    hostname  string
    login     string
}
```

**Factory:**
```go
func NewMeReplacer(apiClient *api.Client, hostname string) *MeReplacer
```

**Methods:**

##### Replace(handle string) (string, error)

**Description:** Replaces "@me" with current user login

##### ReplaceSlice(handles []string) ([]string, error)

**Description:** Replaces "@me" in all elements of a slice

---

#### CopilotReplacer

**Description:** Utility for resolving `@copilot` to Copilot's login or name

**Definition:**
```go
type CopilotReplacer struct {
    returnLogin bool
}
```

**Factory:**
```go
func NewCopilotReplacer(returnLogin bool) *CopilotReplacer
```

**Methods:**

##### ReplaceSlice(handles []string) []string

**Description:** Replaces "@copilot" in all elements of a slice

---

## Constant Values

### Package: `api`

#### PullRequestFields

**Description:** Exported field names for pull request JSON output

**Type:** []string

**Value:** Includes fields like:
- additions, autoMergeRequest, baseRefName, baseRefOid
- changedFiles, closingIssuesReferences, commits, deletions
- files, fullDatabaseId, headRefName, headRefOid
- headRepository, headRepositoryOwner, isCrossRepository, isDraft
- latestReviews, maintainerCanModify, mergeable, mergeCommit
- mergedAt, mergedBy, mergeStateStatus, potentialMergeCommit
- reviewDecision, reviewRequests, reviews, statusCheckRollup
- Plus all shared issue/PR fields (assignees, author, body, closedAt, etc.)

**Usage:**
```go
cmdutil.AddJSONFlags(cmd, &opts.Exporter, api.PullRequestFields)
```

---

## Adaptation Recommendations

### Core Interface

**Essential components to replicate:**

1. **Factory Pattern**
   - Factory struct with dependency injection
   - Lazy-loaded dependencies via functions
   - Direct dependency injection for concrete types

2. **Command Creation Contract**
   - NewCmd* function signature pattern
   - Options struct pattern
   - Test injection via runF parameter

3. **Flag Helpers**
   - NilStringFlag and NilBoolFlag for tri-state values
   - StringEnumFlag for validated options
   - RegisterBranchCompletionFlags for git integration

4. **JSON Export**
   - Exporter interface
   - AddJSONFlags for --json, --jq, --template
   - exportable interface for custom serialization

5. **Error Types**
   - FlagError for usage display
   - Sentinel errors (SilentError, CancelError, PendingError)
   - NoResultsError for empty results

---

### Optional Interface

**Features that could be omitted or simplified:**

1. **Editable Types**
   - Complex for interactive editing workflows
   - Could use simpler approach if no interactive editing needed

2. **Feature Detection**
   - Needed only for GHES compatibility
   - Can omit if targeting github.com only

3. **Extension Manager**
   - Needed only if supporting extensions
   - Can use stub implementation if extensions not required

4. **MeReplacer/CopilotReplacer**
   - Convenience utilities
   - Can implement inline if needed

---

### Extension Considerations

**How extensibility could be handled:**

1. **Extension Point: Factory Construction**
   - Allow custom dependency providers
   - Support dependency override for testing

2. **Extension Point: Command Registration**
   - Hook for adding custom commands
   - ExtensionManager.Dispatch pattern for routing

3. **Extension Point: Flag Processing**
   - Custom flag types via pflag.Value interface
   - PreRunE hooks for validation

4. **Extension Point: Output Formatting**
   - Exporter interface for custom formats
   - exportable interface for custom serialization

5. **Extension Point: Interactive Prompts**
   - Prompter interface for custom UX
   - EditPrompter subset for metadata editing

---

## Implementation Notes

### Testing Patterns

**Factory Injection:**
```go
func TestCommand(t *testing.T) {
    factory := &cmdutil.Factory{
        IOStreams:  iostreams.Test(),
        HttpClient: func() (*http.Client, error) {
            return &http.Client{
                Transport: httpmock.Fixture(...),
            }, nil
        },
    }

    var opts *ListOptions
    cmd := NewCmdList(factory, func(o *ListOptions) error {
        opts = o
        return nil
    })

    cmd.SetArgs([]string{"--state", "closed"})
    cmd.Execute()

    assert.Equal(t, "closed", opts.State)
}
```

---

### Dependency Resolution Order

1. **Immediate dependencies** (IOStreams, Browser, Prompter): Injected at factory construction
2. **Lazy dependencies** (HttpClient, Config, BaseRepo): Resolved when first accessed
3. **Command-specific state**: Initialized in Options struct
4. **Runtime values**: Set in RunE handler

---

### Flag Validation Timing

1. **Syntax validation**: Handled by pflag during parsing
2. **Enum validation**: Handled by StringEnumFlag.Set()
3. **Mutual exclusion**: Checked in RunE handler
4. **Business logic**: Checked in run function

---

### Error Handling Strategy

1. **Flag errors**: Return FlagError to show usage
2. **User cancellation**: Return CancelError to exit cleanly
3. **API errors**: Wrap and return with context
4. **Validation errors**: Return with clear message
5. **Silent exit**: Return SilentError (exit code 1, no message)

---

## Versioning and Stability

**Stability:** Internal API (not semver-versioned)

**Breaking Change Policy:**
- Factory struct: Additive changes only (new fields)
- Interfaces: Changes require adapter/wrapper pattern
- Functions: Signature changes break consumers

**Compatibility Considerations:**
- Commands depend on stable Factory interface
- Tests depend on Factory injection pattern
- Extensions depend on ExtensionManager interface

---

## See Also

**Related Packages:**
- `github.com/spf13/cobra` - Command framework
- `github.com/spf13/pflag` - Flag parsing
- `github.com/cli/go-gh/v2` - GitHub API client library
- `github.com/AlecAivazis/survey/v2` - Terminal prompts
- `github.com/charmbracelet/huh` - Accessible terminal forms

**Documentation:**
- Cobra documentation: https://github.com/spf13/cobra
- go-gh documentation: https://github.com/cli/go-gh

---

**End of API Surface Documentation**
