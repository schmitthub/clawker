# Test advanced resource constraint flags
# Verifies: Resource limit flags are supported and set correctly

# Substitute project name in config
replace clawker.yaml PROJECT=$PROJECT

# Create settings directory
mkdir $HOME/.local/clawker

# Test --memory-reservation flag via create + inspect
defer clawker container rm --force --agent memres-$RANDOM_STRING
exec clawker container create --agent memres-$RANDOM_STRING --memory-reservation 128m alpine:latest sleep 3600
exec clawker container inspect --format '{{.HostConfig.MemoryReservation}}' --agent memres-$RANDOM_STRING
stdout '134217728'

# Test --shm-size flag via create + inspect
defer clawker container rm --force --agent shm-$RANDOM_STRING
exec clawker container create --agent shm-$RANDOM_STRING --shm-size 256m alpine:latest sleep 3600
exec clawker container inspect --format '{{.HostConfig.ShmSize}}' --agent shm-$RANDOM_STRING
stdout '268435456'

# Test --pids-limit flag via create + inspect
defer clawker container rm --force --agent pids-$RANDOM_STRING
exec clawker container create --agent pids-$RANDOM_STRING --pids-limit 100 alpine:latest sleep 3600
exec clawker container inspect --format '{{.HostConfig.PidsLimit}}' --agent pids-$RANDOM_STRING
stdout '100'

# Test --cpuset-cpus flag via create + inspect
defer clawker container rm --force --agent cpuset-$RANDOM_STRING
exec clawker container create --agent cpuset-$RANDOM_STRING --cpuset-cpus 0 alpine:latest sleep 3600
exec clawker container inspect --format '{{.HostConfig.CpusetCpus}}' --agent cpuset-$RANDOM_STRING
stdout '0'

-- clawker.yaml --
version: "1"
project: "$PROJECT"

build:
  image: "alpine:latest"

security:
  firewall:
    enable: false
