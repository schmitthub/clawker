# Generated by Claucker - Claude Container Orchestration
# Do not edit directly - modify claucker.yaml instead

FROM {{.BaseImage}}

ARG TZ=UTC
ENV TZ="$TZ"
ENV DEBIAN_FRONTEND=noninteractive

# Install system packages
{{if .IsAlpine -}}
RUN apk add --no-cache \
    bash \
    curl \
    git \
    sudo \
    ca-certificates \
    {{- range .Packages}}
    {{.}} \
    {{- end}}
    && rm -rf /var/cache/apk/*
{{else -}}
RUN apt-get update && apt-get install -y --no-install-recommends \
    bash \
    curl \
    git \
    sudo \
    ca-certificates \
    {{- range .Packages}}
    {{.}} \
    {{- end}}
    && apt-get clean && rm -rf /var/lib/apt/lists/*
{{end}}

{{if .EnableFirewall -}}
# Install firewall packages
{{if .IsAlpine -}}
RUN apk add --no-cache iptables ipset iproute2
{{else -}}
RUN apt-get update && apt-get install -y --no-install-recommends \
    iptables \
    ipset \
    iproute2 \
    && apt-get clean && rm -rf /var/lib/apt/lists/*
{{end}}
{{end}}

# Setup non-root user
ARG USERNAME={{.Username}}
ARG USER_UID={{.UID}}
ARG USER_GID={{.GID}}

{{if .IsAlpine -}}
RUN addgroup -g ${USER_GID} ${USERNAME} \
    && adduser -D -u ${USER_UID} -G ${USERNAME} -s {{.Shell}} ${USERNAME} \
    && echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/${USERNAME} \
    && chmod 0440 /etc/sudoers.d/${USERNAME}
{{else -}}
RUN groupadd --gid ${USER_GID} ${USERNAME} \
    && useradd --uid ${USER_UID} --gid ${USER_GID} --shell {{.Shell}} --create-home ${USERNAME} \
    && echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/${USERNAME} \
    && chmod 0440 /etc/sudoers.d/${USERNAME}
{{end}}

# Create workspace and config directories
RUN mkdir -p {{.WorkspacePath}} /home/${USERNAME}/.claude /commandhistory \
    && chown -R ${USERNAME}:${USERNAME} {{.WorkspacePath}} /home/${USERNAME}/.claude /commandhistory

# Copy scripts
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

{{if .EnableFirewall -}}
COPY init-firewall.sh /usr/local/bin/init-firewall.sh
RUN chmod +x /usr/local/bin/init-firewall.sh
{{end}}

# Switch to non-root user
USER ${USERNAME}
WORKDIR {{.WorkspacePath}}

# Set environment
ENV HOME=/home/${USERNAME}
ENV SHELL={{.Shell}}
ENV PATH="/home/${USERNAME}/.local/bin:${PATH}"

# Install Claude Code
RUN curl -fsSL "https://claude.ai/install.sh" | bash -s -- {{.ClaudeVersion}}

{{range $key, $value := .ExtraEnv -}}
ENV {{$key}}="{{$value}}"
{{end}}

ENTRYPOINT ["entrypoint.sh"]
CMD ["claude"]
