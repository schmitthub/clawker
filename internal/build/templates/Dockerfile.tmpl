# Generated by Clawker - Claude Container Orchestration
# Base image for Claude Code {{.ClaudeVersion}} on {{.BaseImage}}

# Builder stage for ssh-agent-proxy
FROM golang:1.23-alpine AS ssh-proxy-builder
WORKDIR /build
COPY ssh-agent-proxy.go .
{{- if .BuildKitEnabled}}
RUN --mount=type=cache,target=/go/pkg/mod \
    CGO_ENABLED=0 go build -ldflags="-s -w" -o ssh-agent-proxy ssh-agent-proxy.go
{{- else}}
RUN CGO_ENABLED=0 go build -ldflags="-s -w" -o ssh-agent-proxy ssh-agent-proxy.go
{{- end}}

# Builder stage for callback-forwarder
FROM golang:1.23-alpine AS callback-forwarder-builder
WORKDIR /build
COPY callback-forwarder.go .
{{- if .BuildKitEnabled}}
RUN --mount=type=cache,target=/go/pkg/mod \
    CGO_ENABLED=0 go build -ldflags="-s -w" -o callback-forwarder callback-forwarder.go
{{- else}}
RUN CGO_ENABLED=0 go build -ldflags="-s -w" -o callback-forwarder callback-forwarder.go
{{- end}}

FROM {{.BaseImage}}

ARG TZ=UTC
ENV TZ="$TZ"

ENV CLAUDE_CODE_VERSION={{.ClaudeVersion}}

{{/* User-defined ARGs */}}
{{- if .Instructions}}
{{- range .Instructions.Args}}
ARG {{.Name}}{{if .Default}}="{{.Default}}"{{end}}
{{- end}}
{{- end}}

{{/* Injection point: after_from */}}
{{- if .Inject}}
{{- range .Inject.AfterFrom}}
{{.}}
{{- end}}
{{- end}}

# Install system packages
{{if .IsAlpine -}}
{{- if $.BuildKitEnabled}}
RUN --mount=type=cache,target=/var/cache/apk,sharing=locked \
    apk add \
{{- else}}
RUN apk add \
{{- end}}
    bash \
    less \
    git \
    procps \
    sudo \
    fzf \
    zsh \
    man-db \
    unzip \
    gnupg \
    iptables \
    ipset \
    iproute2 \
    bind-tools \
    jq \
    nano \
    vim \
    wget \
    curl \
    github-cli \
    musl-locales \
    musl-locales-lang \
    {{- range .Packages}}
    {{.}} \
    {{- end}}
    && true
{{else -}}
{{- if $.BuildKitEnabled}}
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
{{- else}}
RUN apt-get update && apt-get install -y --no-install-recommends \
{{- end}}
    less \
    git \
    procps \
    sudo \
    fzf \
    zsh \
    man-db \
    unzip \
    gnupg2 \
    iptables \
    ipset \
    iproute2 \
    dnsutils \
    aggregate \
    jq \
    nano \
    vim \
    wget \
    curl \
    gh \
    locales \
    locales-all \
    {{- range .Packages}}
    {{.}} \
    {{- end}}
    && true
{{end}}

{{/* Injection point: after_packages */}}
{{- if .Inject}}
{{- range .Inject.AfterPackages}}
{{.}}
{{- end}}
{{- end}}

# Install Docker CLI (not daemon - we use host's Docker via socket mount)
{{if .IsAlpine -}}
{{- if $.BuildKitEnabled}}
RUN --mount=type=cache,target=/var/cache/apk,sharing=locked \
    apk add \
{{- else}}
RUN apk add \
{{- end}}
    docker-cli \
    docker-cli-buildx \
    docker-cli-compose
{{else -}}
{{- if $.BuildKitEnabled}}
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    install -m 0755 -d /etc/apt/keyrings && \
{{- else}}
RUN install -m 0755 -d /etc/apt/keyrings && \
{{- end}}
    curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc && \
    chmod a+r /etc/apt/keyrings/docker.asc && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" > /etc/apt/sources.list.d/docker.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends docker-ce-cli docker-buildx-plugin docker-compose-plugin
{{end}}

# Setup locale
{{if .IsAlpine -}}
# Alpine uses musl-locales, no locale-gen needed
{{else -}}
RUN locale-gen en_US.UTF-8
{{end}}

{{/* Root-mode RUN commands (before user setup) */}}
{{- if .Instructions}}
{{- range .Instructions.RootRun}}
{{- if .Cmd}}
RUN {{.Cmd}}
{{- else if $.IsAlpine}}
{{- if .Alpine}}
RUN {{.Alpine}}
{{- end}}
{{- else}}
{{- if .Debian}}
RUN {{.Debian}}
{{- end}}
{{- end}}
{{- end}}
{{- end}}

ARG USERNAME={{.Username}}

# Setup non-root user
{{if .IsAlpine -}}
RUN addgroup -g {{.GID}} ${USERNAME} \
    && adduser -D -u {{.UID}} -G ${USERNAME} -s {{.Shell}} ${USERNAME}
{{else -}}
RUN groupadd --gid {{.GID}} ${USERNAME} \
    && useradd --uid {{.UID}} --gid ${USERNAME} --shell {{.Shell}} --create-home ${USERNAME}
{{end}}

# Create docker group and add user for socket access
{{if .IsAlpine -}}
RUN addgroup -g 999 docker 2>/dev/null || addgroup docker 2>/dev/null || true && adduser ${USERNAME} docker
{{else -}}
RUN groupadd -g 999 docker 2>/dev/null || groupadd docker 2>/dev/null || true && usermod -aG docker ${USERNAME}
{{end}}

{{/* Injection point: after_user_setup */}}
{{- if .Inject}}
{{- range .Inject.AfterUserSetup}}
{{.}}
{{- end}}
{{- end}}

# Create workspace, config, and runtime directories with proper permissions
RUN mkdir -p /home/${USERNAME}/.claude {{.WorkspacePath}} /var/run/clawker && \
    chown -R ${USERNAME}:${USERNAME} {{.WorkspacePath}} /home/${USERNAME}/.claude /var/run/clawker

# Persist bash history
RUN SNIPPET="export PROMPT_COMMAND='history -a' && export HISTFILE=/commandhistory/.bash_history" \
    && mkdir /commandhistory \
    && touch /commandhistory/.bash_history \
    && chown -R ${USERNAME} /commandhistory

WORKDIR {{.WorkspacePath}}

# Install git-delta
{{if .IsAlpine -}}
{{- if $.BuildKitEnabled}}
RUN --mount=type=cache,target=/var/cache/apk,sharing=locked \
    apk add delta
{{- else}}
RUN apk add delta
{{- end}}
{{else -}}
ARG GIT_DELTA_VERSION=0.18.2
{{- if $.BuildKitEnabled}}
RUN --mount=type=cache,target=/tmp/downloads \
    ARCH=$(dpkg --print-architecture) && \
{{- else}}
RUN ARCH=$(dpkg --print-architecture) && \
{{- end}}
    DEB="git-delta_${GIT_DELTA_VERSION}_${ARCH}.deb" && \
    [ -f "/tmp/downloads/$DEB" ] || wget -O "/tmp/downloads/$DEB" "https://github.com/dandavison/delta/releases/download/${GIT_DELTA_VERSION}/$DEB" && \
    dpkg -i "/tmp/downloads/$DEB"
{{end}}

# Copy and set up firewall script
{{if .EnableFirewall -}}
COPY init-firewall.sh /usr/local/bin/init-firewall.sh
RUN chmod +x /usr/local/bin/init-firewall.sh && \
    echo "${USERNAME} ALL=(root) NOPASSWD: /usr/local/bin/init-firewall.sh" > /etc/sudoers.d/${USERNAME}-firewall && \
    chmod 0440 /etc/sudoers.d/${USERNAME}-firewall
{{end}}

# Host proxy client scripts for container-to-host communication
COPY host-open.sh /usr/local/bin/host-open
COPY --from=callback-forwarder-builder /build/callback-forwarder /usr/local/bin/callback-forwarder
COPY git-credential-clawker.sh /usr/local/bin/git-credential-clawker
RUN chmod +x /usr/local/bin/host-open /usr/local/bin/callback-forwarder /usr/local/bin/git-credential-clawker

# SSH agent proxy binary for forwarding SSH agent requests via host proxy
COPY --from=ssh-proxy-builder /build/ssh-agent-proxy /usr/local/bin/ssh-agent-proxy
RUN chmod +x /usr/local/bin/ssh-agent-proxy

# Switch to non-root user
USER ${USERNAME}

# Set static environment (PATH, SHELL, BROWSER â€” not config-dependent)
ENV SHELL={{.Shell}}
ENV PATH=/home/${USERNAME}/.local/bin:$PATH
# Set BROWSER so CLI tools (like Claude Code) use host-open for URLs
ENV BROWSER=/usr/local/bin/host-open

{{/* Injection point: after_user_switch */}}
{{- if .Inject}}
{{- range .Inject.AfterUserSwitch}}
{{.}}
{{- end}}
{{- end}}

# Use zsh-in-docker to configure plugins and theme
ARG ZSH_IN_DOCKER_VERSION=1.2.0
ARG ZSH_THEME=default
{{if .IsAlpine -}}
RUN sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v${ZSH_IN_DOCKER_VERSION}/zsh-in-docker.sh)" -- \
    -t ${ZSH_THEME} \
    -p git \
    -p fzf \
    -a "source /usr/share/fzf/key-bindings.zsh" \
    -a "source /usr/share/fzf/completion.zsh" \
    -a "export PROMPT_COMMAND='history -a' && export HISTFILE=/commandhistory/.bash_history" \
    -x
{{else -}}
RUN sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v${ZSH_IN_DOCKER_VERSION}/zsh-in-docker.sh)" -- \
    -t ${ZSH_THEME} \
    -p git \
    -p fzf \
    -a "source /usr/share/doc/fzf/examples/key-bindings.zsh" \
    -a "source /usr/share/doc/fzf/examples/completion.zsh" \
    -a "export PROMPT_COMMAND='history -a' && export HISTFILE=/commandhistory/.bash_history" \
    -x
{{end}}

{{/* User-mode RUN commands (as claude user) */}}
{{- if .Instructions}}
{{- range .Instructions.UserRun}}
{{- if .Cmd}}
RUN {{.Cmd}}
{{- else if $.IsAlpine}}
{{- if .Alpine}}
RUN {{.Alpine}}
{{- end}}
{{- else}}
{{- if .Debian}}
RUN {{.Debian}}
{{- end}}
{{- end}}
{{- end}}
{{- end}}

# Install Claude Code
{{- if .BuildKitEnabled}}
RUN --mount=type=cache,target=/home/${USERNAME}/.npm \
    curl -fsSL "https://claude.ai/install.sh" | bash -s ${CLAUDE_CODE_VERSION}
{{- else}}
RUN curl -fsSL "https://claude.ai/install.sh" | bash -s ${CLAUDE_CODE_VERSION}
{{- end}}

# Stage config files for volume initialization (not shadowed by volume mount)
COPY --chown=${USERNAME}:${USERNAME} statusline.sh /home/${USERNAME}/.claude-init/statusline.sh
COPY --chown=${USERNAME}:${USERNAME} claude-settings.json /home/${USERNAME}/.claude-init/settings.json

{{/* COPY instructions (as user, after expensive build steps for better caching) */}}
{{- if .Instructions}}
{{- range .Instructions.Copy}}
COPY {{if .Chown}}--chown={{.Chown}} {{end}}{{if .Chmod}}--chmod={{.Chmod}} {{end}}{{.Src}} {{.Dest}}
{{- end}}
{{- end}}

{{/* Injection point: after_claude_install */}}
{{- if .Inject}}
{{- range .Inject.AfterClaudeInstall}}
{{.}}
{{- end}}
{{- end}}

# Health check for container readiness (checks for ready signal file)
HEALTHCHECK --interval=5s --timeout=3s --start-period=30s --retries=3 \
    CMD test -f /var/run/clawker/ready || exit 1

{{/* Injection point: before_entrypoint */}}
{{- if .Inject}}
{{- range .Inject.BeforeEntrypoint}}
{{.}}
{{- end}}
{{- end}}

# Copy and set up entrypoint script
COPY entrypoint.sh /usr/local/bin/
ENTRYPOINT ["entrypoint.sh"]
CMD ["claude"]
