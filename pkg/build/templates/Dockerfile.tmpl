# Generated by Clawker - Claude Container Orchestration
# Base image for Claude Code {{.ClaudeVersion}} on {{.BaseImage}}

FROM {{.BaseImage}}

ARG TZ=UTC
ENV TZ="$TZ"

ENV CLAUDE_CODE_VERSION={{.ClaudeVersion}}

{{/* User-defined ARGs */}}
{{- if .Instructions}}
{{- range .Instructions.Args}}
ARG {{.Name}}{{if .Default}}="{{.Default}}"{{end}}
{{- end}}
{{- end}}

{{/* Injection point: after_from */}}
{{- if .Inject}}
{{- range .Inject.AfterFrom}}
{{.}}
{{- end}}
{{- end}}

# Install system packages
{{if .IsAlpine -}}
RUN apk add --no-cache \
    bash \
    less \
    git \
    procps \
    sudo \
    fzf \
    zsh \
    man-db \
    unzip \
    gnupg \
    iptables \
    ipset \
    iproute2 \
    bind-tools \
    jq \
    nano \
    vim \
    wget \
    curl \
    github-cli \
    musl-locales \
    musl-locales-lang \
    {{- range .Packages}}
    {{.}} \
    {{- end}}
    && rm -rf /var/cache/apk/*
{{else -}}
RUN apt-get update && apt-get install -y --no-install-recommends \
    less \
    git \
    procps \
    sudo \
    fzf \
    zsh \
    man-db \
    unzip \
    gnupg2 \
    iptables \
    ipset \
    iproute2 \
    dnsutils \
    aggregate \
    jq \
    nano \
    vim \
    wget \
    curl \
    gh \
    locales \
    locales-all \
    {{- range .Packages}}
    {{.}} \
    {{- end}}
    && apt-get clean && rm -rf /var/lib/apt/lists/*
{{end}}

{{/* Injection point: after_packages */}}
{{- if .Inject}}
{{- range .Inject.AfterPackages}}
{{.}}
{{- end}}
{{- end}}

# Install Docker CLI (not daemon - we use host's Docker via socket mount)
{{if .IsAlpine -}}
RUN apk add --no-cache \
    docker-cli \
    docker-cli-buildx \
    docker-cli-compose
{{else -}}
RUN install -m 0755 -d /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc && \
    chmod a+r /etc/apt/keyrings/docker.asc && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" > /etc/apt/sources.list.d/docker.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends docker-ce-cli docker-buildx-plugin docker-compose-plugin && \
    apt-get clean && rm -rf /var/lib/apt/lists/*
{{end}}

# Setup locale
{{if .IsAlpine -}}
# Alpine uses musl-locales, no locale-gen needed
{{else -}}
RUN locale-gen en_US.UTF-8
{{end}}

{{/* Root-mode RUN commands (before user setup) */}}
{{- if .Instructions}}
{{- range .Instructions.RootRun}}
{{- if .Cmd}}
RUN {{.Cmd}}
{{- else if $.IsAlpine}}
{{- if .Alpine}}
RUN {{.Alpine}}
{{- end}}
{{- else}}
{{- if .Debian}}
RUN {{.Debian}}
{{- end}}
{{- end}}
{{- end}}
{{- end}}

ARG USERNAME={{.Username}}

# Setup non-root user
{{if .IsAlpine -}}
RUN addgroup -g {{.GID}} ${USERNAME} \
    && adduser -D -u {{.UID}} -G ${USERNAME} -s {{.Shell}} ${USERNAME}
{{else -}}
RUN groupadd --gid {{.GID}} ${USERNAME} \
    && useradd --uid {{.UID}} --gid ${USERNAME} --shell {{.Shell}} --create-home ${USERNAME}
{{end}}

# Create docker group and add user for socket access
{{if .IsAlpine -}}
RUN addgroup -g 999 docker 2>/dev/null || addgroup docker 2>/dev/null || true && adduser ${USERNAME} docker
{{else -}}
RUN groupadd -g 999 docker 2>/dev/null || groupadd docker 2>/dev/null || true && usermod -aG docker ${USERNAME}
{{end}}

{{/* Injection point: after_user_setup */}}
{{- if .Inject}}
{{- range .Inject.AfterUserSetup}}
{{.}}
{{- end}}
{{- end}}

# Create workspace and config directories and set permissions
RUN mkdir -p /home/${USERNAME}/.claude {{.WorkspacePath}} && \
    chown -R ${USERNAME}:${USERNAME} {{.WorkspacePath}} /home/${USERNAME}/.claude

# Persist bash history
RUN SNIPPET="export PROMPT_COMMAND='history -a' && export HISTFILE=/commandhistory/.bash_history" \
    && mkdir /commandhistory \
    && touch /commandhistory/.bash_history \
    && chown -R ${USERNAME} /commandhistory

WORKDIR {{.WorkspacePath}}

# Install git-delta
{{if .IsAlpine -}}
RUN apk add --no-cache delta
{{else -}}
ARG GIT_DELTA_VERSION=0.18.2
RUN ARCH=$(dpkg --print-architecture) && \
    wget "https://github.com/dandavison/delta/releases/download/${GIT_DELTA_VERSION}/git-delta_${GIT_DELTA_VERSION}_${ARCH}.deb" && \
    dpkg -i "git-delta_${GIT_DELTA_VERSION}_${ARCH}.deb" && \
    rm "git-delta_${GIT_DELTA_VERSION}_${ARCH}.deb"
{{end}}

# Install hadolint (Dockerfile linter)
ARG HADOLINT_VERSION=2.12.0
{{if .IsAlpine -}}
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then ARCH="x86_64"; \
    elif [ "$ARCH" = "aarch64" ]; then ARCH="arm64"; fi && \
    wget "https://github.com/hadolint/hadolint/releases/download/v${HADOLINT_VERSION}/hadolint-Linux-${ARCH}" -O /usr/local/bin/hadolint && \
    chmod +x /usr/local/bin/hadolint
{{else -}}
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "amd64" ]; then ARCH="x86_64"; fi && \
    wget "https://github.com/hadolint/hadolint/releases/download/v${HADOLINT_VERSION}/hadolint-Linux-${ARCH}" -O /usr/local/bin/hadolint && \
    chmod +x /usr/local/bin/hadolint
{{end}}

{{/* COPY instructions (as root, for proper permissions) */}}
{{- if .Instructions}}
{{- range .Instructions.Copy}}
COPY {{if .Chown}}--chown={{.Chown}} {{end}}{{if .Chmod}}--chmod={{.Chmod}} {{end}}{{.Src}} {{.Dest}}
{{- end}}
{{- end}}

{{/* Labels */}}
{{- if .Instructions}}
{{- range $key, $value := .Instructions.Labels}}
LABEL {{$key}}="{{$value}}"
{{- end}}
{{- end}}

{{/* Clawker Image Labels */}}
{{- if .ImageLabels}}
{{- range $key, $value := .ImageLabels}}
LABEL {{$key}}="{{$value}}"
{{- end}}
{{- end}}

{{/* EXPOSE ports */}}
{{- if .Instructions}}
{{- range .Instructions.Expose}}
EXPOSE {{.Port}}{{if .Protocol}}/{{.Protocol}}{{end}}
{{- end}}
{{- end}}

{{/* VOLUME declarations */}}
{{- if .Instructions}}
{{- range .Instructions.Volumes}}
VOLUME {{.}}
{{- end}}
{{- end}}

# Copy and set up firewall script
{{if .EnableFirewall -}}
COPY init-firewall.sh /usr/local/bin/init-firewall.sh
RUN chmod +x /usr/local/bin/init-firewall.sh && \
    echo "${USERNAME} ALL=(root) NOPASSWD: /usr/local/bin/init-firewall.sh" > /etc/sudoers.d/${USERNAME}-firewall && \
    chmod 0440 /etc/sudoers.d/${USERNAME}-firewall
{{end}}

# Switch to non-root user
USER ${USERNAME}

# Set environment config
ENV SHELL={{.Shell}}
ENV EDITOR={{.Editor}}
ENV VISUAL={{.Visual}}
ENV PATH=/home/${USERNAME}/.local/bin:$PATH

{{/* Injection point: after_user_switch */}}
{{- if .Inject}}
{{- range .Inject.AfterUserSwitch}}
{{.}}
{{- end}}
{{- end}}

{{/* User-defined ENV variables from instructions */}}
{{- if .Instructions}}
{{- range $key, $value := .Instructions.Env}}
ENV {{$key}}="{{$value}}"
{{- end}}
{{- end}}

# Use zsh-in-docker to configure plugins and theme
ARG ZSH_IN_DOCKER_VERSION=1.2.0
ARG ZSH_THEME=default
{{if .IsAlpine -}}
RUN sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v${ZSH_IN_DOCKER_VERSION}/zsh-in-docker.sh)" -- \
    -t ${ZSH_THEME} \
    -p git \
    -p fzf \
    -a "source /usr/share/fzf/key-bindings.zsh" \
    -a "source /usr/share/fzf/completion.zsh" \
    -a "export PROMPT_COMMAND='history -a' && export HISTFILE=/commandhistory/.bash_history" \
    -x
{{else -}}
RUN sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v${ZSH_IN_DOCKER_VERSION}/zsh-in-docker.sh)" -- \
    -t ${ZSH_THEME} \
    -p git \
    -p fzf \
    -a "source /usr/share/doc/fzf/examples/key-bindings.zsh" \
    -a "source /usr/share/doc/fzf/examples/completion.zsh" \
    -a "export PROMPT_COMMAND='history -a' && export HISTFILE=/commandhistory/.bash_history" \
    -x
{{end}}

{{/* User-mode RUN commands (as claude user) */}}
{{- if .Instructions}}
{{- range .Instructions.UserRun}}
{{- if .Cmd}}
RUN {{.Cmd}}
{{- else if $.IsAlpine}}
{{- if .Alpine}}
RUN {{.Alpine}}
{{- end}}
{{- else}}
{{- if .Debian}}
RUN {{.Debian}}
{{- end}}
{{- end}}
{{- end}}
{{- end}}

{{/* Shell configuration */}}
{{- if and .Instructions (gt (len .Instructions.Shell) 0)}}
SHELL [{{range $i, $e := .Instructions.Shell}}{{if $i}}, {{end}}"{{$e}}"{{end}}]
{{- end}}

# Set the default editor and visual
ENV EDITOR={{.Editor}}
ENV VISUAL={{.Visual}}

{{/* Extra ENV from agent config */}}
{{- range $key, $value := .ExtraEnv}}
ENV {{$key}}="{{$value}}"
{{- end}}

{{/* HEALTHCHECK */}}
{{- if and .Instructions .Instructions.Healthcheck}}
HEALTHCHECK {{if .Instructions.Healthcheck.Interval}}--interval={{.Instructions.Healthcheck.Interval}} {{end}}{{if .Instructions.Healthcheck.Timeout}}--timeout={{.Instructions.Healthcheck.Timeout}} {{end}}{{if .Instructions.Healthcheck.Retries}}--retries={{.Instructions.Healthcheck.Retries}} {{end}}{{if .Instructions.Healthcheck.StartPeriod}}--start-period={{.Instructions.Healthcheck.StartPeriod}} {{end}}CMD [{{range $i, $e := .Instructions.Healthcheck.Cmd}}{{if $i}}, {{end}}"{{$e}}"{{end}}]
{{- end}}

# Install Claude Code
RUN curl -fsSL "https://claude.ai/install.sh" | bash -s ${CLAUDE_CODE_VERSION}

# Stage config files for volume initialization (not shadowed by volume mount)
COPY --chown=${USERNAME}:${USERNAME} statusline.sh /home/${USERNAME}/.claude-init/statusline.sh
COPY --chown=${USERNAME}:${USERNAME} claude-settings.json /home/${USERNAME}/.claude-init/settings.json

{{/* Injection point: after_claude_install */}}
{{- if .Inject}}
{{- range .Inject.AfterClaudeInstall}}
{{.}}
{{- end}}
{{- end}}

{{/* Injection point: before_entrypoint */}}
{{- if .Inject}}
{{- range .Inject.BeforeEntrypoint}}
{{.}}
{{- end}}
{{- end}}

# Copy and set up entrypoint script
COPY entrypoint.sh /usr/local/bin/
ENTRYPOINT ["entrypoint.sh"]
CMD ["claude"]
