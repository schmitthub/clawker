# Clawker Configuration
# Documentation: https://github.com/schmitthub/clawker

version: "1"

build:
  # Base image for the container
  image: "buildpack-deps:bookworm-scm"
  # Optional: path to custom Dockerfile (relative to project root)
  # dockerfile: "docker/2.1.2/Dockerfile"
  # System packages to install (apt-get on Debian, apk on Alpine)
  packages:
    - git
    - curl
    - ripgrep
    - less
    - procps
    - sudo
    - fzf
    - zsh
    - man-db
    - unzip
    - gnupg2
    - iptables
    - ipset
    - iproute2
    - dnsutils
    - aggregate
    - jq
    - nano
    - vim
    - wget
    - curl
    - gh
    - locales
    - locales-all
    - iputils-ping
    - nodejs
    - npm
  instructions:
    root_run:
      - cmd: |
          ARCH=$(dpkg --print-architecture) && \
            curl -fsSL "https://golang.org/dl/go1.25.5.linux-${ARCH}.tar.gz" | tar -C /usr/local -xzf - \
            && echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile.d/go.sh
    user_run:
      - cmd: curl -LsSf https://astral.sh/uv/install.sh | sh
      - cmd: uv tool install pre-commit --with pre-commit-uv
      - cmd: /usr/local/go/bin/go install golang.org/x/tools/gopls@latest
      - cmd: /usr/local/go/bin/go install gotest.tools/gotestsum@latest
      - cmd: /usr/local/go/bin/go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest
      - cmd: /usr/local/go/bin/go install golang.org/x/vuln/cmd/govulncheck@latest
      - cmd: uv tool install semgrep

  inject:
    # after_from: # docker instructions to run after the base image FROM instruction
    # after_packages: # docker instructions to run after installing system packages
    # after_user_setup: # docker instructions to run after creation of the non-root user but before switching to it
    after_user_switch: ENV PATH="$PATH:/usr/local/go/bin:/home/${USERNAME}/go/bin" # docker instructions to run after switching to the non-root user
    # after_claude_install: 
    # before_entrypoint: # docker instructions to run before the container entrypoint

agent:
  # Files to make available to Claude (prompts, docs, memory)
  # includes:
  #   - "./README.md"
    # - "./.claude/memory.md"
  # editor: "vim"    # defaults to "nano" if not set
  # visual: "vim"    # defaults to "nano" if not set

  # Environment variable injection (precedence: env_file < from_env < env)
  #  env_file:
  #    - ".env"
  # from_env: passthrough host env vars by name (unset vars skipped with warning)
  from_env:
    - GH_TOKEN
    - CONTEXT7_API_KEY
  # env: static key-value pairs (highest precedence, always win)
  # env:
  #   FOO: bar
  claude_code:
    # Use host authentication tokens in container
    use_host_auth: true
    config:
      # "copy" copies host ~/.claude/ config, "fresh" starts clean
      strategy: "copy"
  # Enable shared directory (read-only, mounted at ~/.clawker-share)
  enable_shared_dir: true
  post_init: |
    claude mcp add -s local serena -- uvx --from git+https://github.com/oraios/serena serena start-mcp-server --context claude-code --project "$(pwd)" --enable-web-dashboard false
    claude mcp add -s user --header "CONTEXT7_API_KEY: $CONTEXT7_API_KEY" --transport http context7 https://mcp.context7.com/mcp
    claude mcp add -s user -t http deepwiki https://mcp.deepwiki.com/mcp

workspace:
  # Container path where your code is mounted
  remote_path: "/workspace"
  # Default mode: "bind" (live sync) or "snapshot" (isolated copy)
  default_mode: "bind"

security:
  # Mount Docker socket for Docker-in-Docker (security risk if enabled)
  docker_socket: true
  # Domains allowed through firewall (only when enable_firewall: true)
  firewall:
    # Enable network firewall (blocks outbound traffic by default)
    enable: true
    # IP range sources for cloud provider APIs (default: [github])
    # WARNING: google ranges include GCS/Firebase which can serve user-generated
    # content - potential prompt injection vector. Only add if needed.
    ip_range_sources:
      - name: github
      - name: google  # Required for Go modules (proxy.golang.org uses GCS)
    add_domains:
      - charm.land
      - code.gitea.io
      - golang.org
      - proxy.golang.org
      - sum.golang.org
      - gocloud.dev
      - gopkg.in
      - software.sslmate.com
      - cloud.google.com
      - sigs.k8s.io
      - google.golang.org
      - storage.googleapis.com
      - go.opentelemetry.io
      - go.uber.org
      - lukechampine.com
      - go.yaml.in
      - cel.dev
      - files.pythonhosted.org
      - code.claude.com
      - mcp.deepwiki.com
      - mcp.context7.com
  # Git credential forwarding
  git_credentials:
    forward_https: true
    forward_ssh: true
    forward_gpg: true
    copy_git_config: true

loop:
  max_loops: 50                   # Maximum loops before stopping (default: 50)
  stagnation_threshold: 3         # Loops without progress before circuit trips (default: 3)
  timeout_minutes: 15             # Per-loop timeout in minutes (default: 15)
  calls_per_hour: 100             # Rate limit: max calls per hour, 0 to disable (default: 100)
  completion_threshold: 2         # Completion indicators required for strict mode (default: 2)
  session_expiration_hours: 24    # Session TTL, auto-reset if older (default: 24)
  same_error_threshold: 5         # Same error repetitions before circuit trips (default: 5)
  output_decline_threshold: 70    # Output decline percentage that triggers trip (default: 70)
  max_consecutive_test_loops: 3   # Test-only loops before circuit trips (default: 3)
  loop_delay_seconds: 3           # Seconds to wait between loop iterations (default: 3)
  safety_completion_threshold: 5  # Force exit after N loops with completion indicators (default: 5)
  skip_permissions: false         # Pass --dangerously-skip-permissions to claude (default: false)
