# SARIF uploads (re-enable when repo goes public):
#
#   permissions:
#     security-events: write
#     actions: read
#
#   In semgrep step, add flags:
#     semgrep scan --sarif --output semgrep.sarif --config p/golang --config p/security-audit --error
#
#   After semgrep step, add:
#     - name: Upload Semgrep SARIF
#       if: always() && hashFiles('semgrep.sarif') != ''
#       uses: github/codeql-action/upload-sarif@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3
#       with:
#         sarif_file: semgrep.sarif
#         category: semgrep
#
#   In gitleaks step, add --report-format sarif --report-path results.sarif
#
#   After gitleaks step, add:
#     - name: Upload Gitleaks SARIF
#       if: always() && hashFiles('results.sarif') != ''
#       uses: github/codeql-action/upload-sarif@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3
#       with:
#         sarif_file: results.sarif
#         category: gitleaks

name: Security

on:
  workflow_call:

permissions:
  contents: read
  pull-requests: read

jobs:
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    container:
      # Pin version for reproducibility. Update periodically:
      #   1. Check latest: https://hub.docker.com/r/semgrep/semgrep/tags
      #   2. Update tag here AND expected version in .pre-commit-config.yaml
      image: semgrep/semgrep:1.146.0
    timeout-minutes: 10
    # Dependabot PRs have limited token permissions and only change
    # go.mod/go.sum â€” SAST scanning is not useful on dependency changes
    if: (github.actor != 'dependabot[bot]')
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      # PRs: incremental scan (only new findings since base branch)
      # Push to main: full scan (no baseline)
      - name: Semgrep
        run: |
          if [ -n "$BASE_SHA" ]; then
            echo "Incremental scan against base $BASE_SHA"
            semgrep scan --baseline-commit "$BASE_SHA" --config p/golang --config p/security-audit --error
          else
            echo "Full scan (no baseline)"
            semgrep scan --config p/golang --config p/security-audit --error
          fi
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}

  gitleaks:
    name: Gitleaks Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      # Use raw CLI instead of gitleaks-action for --baseline-path support.
      # The gitleaks-action (v2) does not expose --baseline-path as an input.
      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION=8.30.0
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" \
            | sudo tar xz -C /usr/local/bin gitleaks
          gitleaks version

      - name: Gitleaks
        run: gitleaks git --baseline-path gitleaks-report.json --report-path findings.json

  govulncheck:
    name: govulncheck SCA
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: govulncheck
        uses: golang/govulncheck-action@b625fbe08f3bccbe446d94fbf87fcc875a4f50ee # v1
        with:
          go-version-file: go.mod
