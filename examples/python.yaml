# Python Developer Image
# Sets up Python via uv with ruff linter and common build dependencies.

version: "1"

# ─── Build ───────────────────────────────────────────────────────────────────
build:
  image: "buildpack-deps:bookworm-scm"

  # Build dependencies for compiled Python extensions
  packages:
    - ca-certificates
    - libssl-dev
    - zlib1g-dev
    - libbz2-dev
    - libreadline-dev
    - libsqlite3-dev
    - libncursesw5-dev
    - xz-utils
    - tk-dev
    - libxml2-dev
    - libxmlsec1-dev
    - libffi-dev
    - liblzma-dev

  inject:
    after_user_switch: |
      ENV UV_PYTHON_PREFERENCE="managed"
      ENV PYTHON_VERSION="3.12"

  instructions:
    # Install uv and Python as the claude user
    user_run:
      - cmd: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
      - cmd: |
          export PATH="$HOME/.local/bin:$PATH" && \
          uv python install $PYTHON_VERSION
      - cmd: |
          export PATH="$HOME/.local/bin:$PATH" && \
          uv tool install ruff
      - cmd: |
          echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc

# ─── Agent ───────────────────────────────────────────────────────────────────
agent:
  from_env:
    - GH_TOKEN
    - PYPI_TOKEN             # for private PyPI uploads
  # env:
  #   PYTHONDONTWRITEBYTECODE: "1"
  post_init: |
    cd /workspace
    if [ -f pyproject.toml ]; then
      uv sync
    elif [ -f requirements.txt ]; then
      uv pip install -r requirements.txt
    fi

# ─── Workspace ───────────────────────────────────────────────────────────────
workspace:
  remote_path: "/workspace"
  default_mode: "bind"

# ─── Security ────────────────────────────────────────────────────────────────
security:
  firewall:
    enable: true
    add_domains:
      - "pypi.org"
      - "files.pythonhosted.org"
    ip_range_sources:
      - name: github
  docker_socket: false
  git_credentials:
    forward_https: true
    forward_ssh: true
    forward_gpg: true
    copy_git_config: true

# ─── Loop (optional) ────────────────────────────────────────────────────────
# loop:
#   max_loops: 50
#   stagnation_threshold: 3
#   timeout_minutes: 15

# ─── Alternative: Use pyenv for version management ──────────────────────────
# build:
#   image: "buildpack-deps:bookworm-scm"
#   packages: [ca-certificates, libssl-dev, zlib1g-dev, libbz2-dev,
#     libreadline-dev, libsqlite3-dev, libncursesw5-dev, xz-utils,
#     tk-dev, libxml2-dev, libxmlsec1-dev, libffi-dev, liblzma-dev]
#   inject:
#     after_user_switch: |
#       ENV PYENV_ROOT="/home/claude/.pyenv"
#       ENV PYTHON_VERSION="3.12"
#   instructions:
#     user_run:
#       - cmd: |
#           curl https://pyenv.run | bash
#       - cmd: |
#           export PATH="$PYENV_ROOT/bin:$PATH" && \
#           eval "$(pyenv init -)" && \
#           pyenv install $PYTHON_VERSION && \
#           pyenv global $PYTHON_VERSION
#       - cmd: |
#           echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc && \
#           echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc && \
#           echo 'eval "$(pyenv init -)"' >> ~/.bashrc
