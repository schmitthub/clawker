# PHP Developer Image
# Sets up PHP 8.3 via sury.org with Composer and common extensions.

version: "1"

# ─── Build ───────────────────────────────────────────────────────────────────
build:
  image: "buildpack-deps:bookworm-scm"

  packages:
    - ca-certificates
    - lsb-release
    - apt-transport-https

  instructions:
    env:
      COMPOSER_HOME: "/home/claude/.composer"
      PHP_VERSION: "8.3"

    # Install PHP and extensions (system-wide)
    root_run:
      - cmd: |
          curl -sSLo /tmp/debsuryorg-archive-keyring.deb \
            https://packages.sury.org/debsuryorg-archive-keyring.deb && \
          dpkg -i /tmp/debsuryorg-archive-keyring.deb && \
          sh -c 'echo "deb [signed-by=/usr/share/keyrings/deb.sury.org-php.gpg] https://packages.sury.org/php/ $(lsb_release -sc) main" > /etc/apt/sources.list.d/sury-php.list' && \
          apt-get update
      - cmd: |
          apt-get install -y \
            php${PHP_VERSION} \
            php${PHP_VERSION}-cli \
            php${PHP_VERSION}-common \
            php${PHP_VERSION}-curl \
            php${PHP_VERSION}-mbstring \
            php${PHP_VERSION}-xml \
            php${PHP_VERSION}-zip \
            php${PHP_VERSION}-mysql \
            php${PHP_VERSION}-pgsql \
            php${PHP_VERSION}-sqlite3

    # Install Composer
    user_run:
      - cmd: |
          curl -sS https://getcomposer.org/installer \
            | php -- --install-dir=$HOME/.local/bin --filename=composer
      - cmd: |
          echo 'export PATH="$HOME/.local/bin:$HOME/.composer/vendor/bin:$PATH"' >> ~/.bashrc

# ─── Agent ───────────────────────────────────────────────────────────────────
agent:
  from_env:
    - GH_TOKEN
    - COMPOSER_AUTH           # for private Packagist repos
  # env:
  #   APP_ENV: "local"
  post_init: |
    cd /workspace
    if [ -f composer.json ]; then
      composer install
    fi

# ─── Workspace ───────────────────────────────────────────────────────────────
workspace:
  remote_path: "/workspace"
  default_mode: "bind"

# ─── Security ────────────────────────────────────────────────────────────────
security:
  firewall:
    enable: true
    add_domains:
      - "packages.sury.org"
      - "packagist.org"
      - "repo.packagist.org"
      - "getcomposer.org"
    ip_range_sources:
      - name: github
  docker_socket: false
  git_credentials:
    forward_https: true
    forward_ssh: true
    forward_gpg: true
    copy_git_config: true

# ─── Loop (optional) ────────────────────────────────────────────────────────
# loop:
#   max_loops: 50
#   stagnation_threshold: 3
#   timeout_minutes: 15

# ─── Alternative: Use official PHP image ─────────────────────────────────────
# build:
#   image: "php:8.3-cli-bookworm"
#   instructions:
#     user_run:
#       - cmd: |
#           curl -sS https://getcomposer.org/installer \
#             | php -- --install-dir=$HOME/.local/bin --filename=composer
