# PHP Project Build Configuration
#
# This example sets up PHP with Composer using the sury.org repository,
# which provides up-to-date PHP versions for Debian.

build:
  # Base image - Debian bookworm with build essentials
  image: "buildpack-deps:bookworm-scm"

  # System packages
  packages:
    - git
    - curl
    - ripgrep
    - ca-certificates
    - lsb-release
    - apt-transport-https

  instructions:
    # Environment variables for PHP and Composer
    env:
      COMPOSER_HOME: "/home/claude/.composer"
      PHP_VERSION: "8.3"

    # Install PHP as root (system-wide)
    root_run:
      # Add sury.org PHP repository
      - cmd: |
          curl -sSLo /tmp/debsuryorg-archive-keyring.deb https://packages.sury.org/debsuryorg-archive-keyring.deb && \
          dpkg -i /tmp/debsuryorg-archive-keyring.deb && \
          sh -c 'echo "deb [signed-by=/usr/share/keyrings/deb.sury.org-php.gpg] https://packages.sury.org/php/ $(lsb_release -sc) main" > /etc/apt/sources.list.d/sury-php.list' && \
          apt-get update

      # Install PHP and common extensions
      - cmd: |
          apt-get install -y \
            php${PHP_VERSION} \
            php${PHP_VERSION}-cli \
            php${PHP_VERSION}-common \
            php${PHP_VERSION}-curl \
            php${PHP_VERSION}-mbstring \
            php${PHP_VERSION}-xml \
            php${PHP_VERSION}-zip \
            php${PHP_VERSION}-mysql \
            php${PHP_VERSION}-pgsql \
            php${PHP_VERSION}-sqlite3

    # Install Composer as the claude user
    user_run:
      # Install Composer
      - cmd: |
          curl -sS https://getcomposer.org/installer | php -- --install-dir=$HOME/.local/bin --filename=composer

      # Add Composer bin to PATH
      - cmd: |
          echo 'export PATH="$HOME/.local/bin:$HOME/.composer/vendor/bin:$PATH"' >> ~/.bashrc

# Alternative: Use the official PHP image as base
# Simpler but may need extension installation:
#
# build:
#   image: "php:8.3-cli-bookworm"
#   packages:
#     - git
#     - ripgrep
#     - unzip
#   instructions:
#     user_run:
#       - cmd: |
#           curl -sS https://getcomposer.org/installer | php -- --install-dir=$HOME/.local/bin --filename=composer
